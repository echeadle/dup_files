<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Filetype Config Editor</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <h1>Edit Included Filetypes</h1>

    {% if msg %}
        <div class="toast">{{ msg }}</div>
    {% endif %}

    <form id="configForm" method="post" action="/config/filetypes">
        <label for="content"><strong>Extensions (one per line):</strong></label><br>
        <textarea name="content" id="content" rows="15" cols="60">{{ file_content }}</textarea><br>
        <div id="status" style="margin: 10px 0; color: #007700;"></div>
        <button type="submit">Save</button>
    </form>

    <hr>

    <h2>üîç Preview Matching Files</h2>
    <input type="text" id="previewDir" placeholder="Enter directory path..." style="width: 300px;" />
    <button onclick="previewFiles()">Preview</button>

    <ul id="previewResults" style="margin-top: 10px;"></ul>

    <script>
    let timeoutId = null;
    const textarea = document.getElementById("content");
    const form = document.getElementById("configForm");
    const statusDiv = document.getElementById("status");

    // Autosave logic
    textarea.addEventListener("input", () => {
        statusDiv.textContent = "‚è≥ Editing...";
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            statusDiv.textContent = "üíæ Saving...";
            fetch("/config/filetypes", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ content: textarea.value })
            })
            .then(() => statusDiv.textContent = "‚úÖ Autosaved")
            .catch(() => statusDiv.textContent = "‚ùå Failed to save");
        }, 2000);
    });

    // Validate before submit
    form.addEventListener("submit", (e) => {
        const lines = textarea.value.trim().split("\n");
        const invalid = lines.filter(line => !line.startsWith("."));
        if (invalid.length) {
            e.preventDefault();
            alert("Validation error: Each line must begin with a period (e.g. .txt, .pdf)");
        }
    });

    // Preview matching files
    function previewFiles() {
        const dir = document.getElementById("previewDir").value;
        const ul = document.getElementById("previewResults");
        ul.innerHTML = "<li>üîÑ Loading...</li>";

        fetch(`/config/filetypes/preview?dir=${encodeURIComponent(dir)}`)
            .then(res => res.json())
            .then(data => {
                ul.innerHTML = "";
                if (data.error) {
                    ul.innerHTML = `<li style="color:red;">‚ùå ${data.error}</li>`;
                    return;
                }

                if (data.matches.length === 0) {
                    ul.innerHTML = "<li>No matching files found.</li>";
                } else {
                    data.matches.forEach(file => {
                        const li = document.createElement("li");
                        li.textContent = file;
                        ul.appendChild(li);
                    });
                }
            })
            .catch(() => {
                ul.innerHTML = "<li style='color:red;'>‚ùå Failed to fetch preview</li>";
            });
    }
    </script>
</body>
</html>
